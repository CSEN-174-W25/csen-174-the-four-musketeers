{% extends 'layout.html' %}

{% block title %}Flashcards - StudyMate{% endblock %}

{% block body_class %}flashcards-page{% endblock %} 

{% block content %}
<div class="container">
    <!-- Floating + Button for creating flashcard sets -->
    <button id="addFlashcardSet" class="floating-add-btn" title="Create a new flashcard set">
        <i class="fas fa-plus"></i>
    </button>

    <div class="row">
        <!-- Left Column: Flashcard Sets -->
        <div class="col-md-4">
            <div class="scrollable-column">
                <ul class="flashcard-sets-list" id="flashcardSetsList">
                    {% if flashcard_sets %}
                        {% for set in flashcard_sets %}
                            <li class="flashcard-set-item" data-set-id="{{ set.id }}">
                                <div class="set-info" onclick="openSet('{{ set.id }}')">
                                    <span class="set-name">{{ set.name }}</span>
                                    <small class="flashcard-count">{{ set.flashcards|length }} flashcards</small>
                                </div>
                                <button class="menu-btn" onclick="toggleMenu(event, '{{ set.id }}')">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <!-- Hidden Action Menu -->
                                <div class="action-menu" id="menu-{{ set.id }}">
                                    <button onclick="openRenameModal('{{ set.id }}', '{{ set.name }}')">Rename</button>
                                    <button onclick="openSet('{{ set.id }}')">Open</button>
                                    <button onclick="openDeleteModal('{{ set.id }}')">Delete</button>
                                </div>
                            </li>
                        {% endfor %}
                    {% else %}
                        <p class="no-sets-msg">No flashcard sets available. Create one!</p>
                    {% endif %}
                </ul>
            </div>
        </div>

        <!-- Right Column: Flashcards in Selected Set -->
        <div class="col-md-8">
            <div class="scrollable-column">
                <!-- Right Column Header (inside flashcardHeader) -->
                <div id="flashcardHeader" class="flashcard-header hidden">
                    <div id="flashcardHeaderLeft" class="flashcard-header-left">
                    <span id="setNameHeader">Set Name</span>
                    <span class="bullet">&#9679;</span>
                    <span id="flashcardCountHeader">0 flashcards</span>
                    </div>
                    <div id="flashcardHeaderRight" class="flashcard-header-right">
                    <!-- Updated Create Button using Bootstrap classes -->
                    <button id="createButton" class="btn btn-success header-btn">Create</button>
                    <button id="shuffleButton" class="btn btn-secondary header-btn">Shuffle</button>
                    <button id="studyButton" class="btn btn-primary header-btn">Study</button>
                    </div>
                </div>
                
                <!-- Flashcard Container (for displaying flashcards in the set) -->
                <div id="flashcardContainer">
                    <p class="text-center text-muted">Select a flashcard set to view its flashcards.</p>
                </div>  
            </div>
        </div>
      </div>
</div>

<!-- Create Flashcard Set Modal -->
<div id="flashcardModal" class="modal">
    <div class="modal-content">
        <button id="closeModalBtn" class="close-btn">&times;</button>
        <h2 class="modal-title">Create a New Flashcard Set</h2>
        <p class="modal-description">Enter a name for your new flashcard set below.</p>
        
        <input type="text" id="flashcardSetName" placeholder="Enter set name..." maxlength="30" required>
        <p class="character-counter" id="charCount">0 / 30</p>
        
        <!-- Primary Action Button (bottom-right) -->
        <button id="createSetBtn" class="action-btn" disabled>Create</button>
    </div>
</div>

<!-- Rename Flashcard Set Modal -->
<div id="renameModal" class="modal">
    <div class="modal-content">
        <button id="closeRenameModalBtn" class="close-btn">&times;</button>
        <h2 class="modal-title">Rename Flashcard Set</h2>
        <p class="modal-description">Enter a new name for your flashcard set.</p>
        
        <input type="text" id="renameFlashcardSetName" placeholder="Enter new set name..." maxlength="30" required>
        <p class="character-counter" id="renameCharCount">0 / 30</p>
        
        <!-- Primary Action Button (bottom-right) -->
        <button id="renameSetBtn" class="action-btn" disabled>Rename</button>
    </div>
</div>

<!-- Delete Flashcard Set Modal -->
<div id="deleteSetModal" class="modal">
    <div class="modal-content">
        <button id="closeDeleteModalBtn" class="close-btn">&times;</button>
        <h2 class="modal-title">Delete Flashcard Set</h2>
        <p class="modal-description">Are you sure you want to delete this flashcard set? This action cannot be undone.</p>
        
        <!-- Two Buttons (side by side at the bottom) -->
        <div class="modal-actions">
            <button id="cancelDeleteSetBtn" class="btn btn-secondary">Cancel</button>
            <button id="confirmDeleteSetBtn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<div id="largeFlashcardCreateModal" class="modal">
    <div class="modal-content large-flashcard-modal">
        <div class="modal-header">
            <h2 class="modal-title">Create a New Flashcard</h2>
            <button id="closeLargeFlashcardCreateModalBtn" class="close-btn">&times;</button>
        </div>
        
        <div class="flashcard-tab-content" id="manualTab">
            <div class="flashcard-form">
                <label for="flashcardQuestion">Question</label>
                <textarea id="flashcardQuestion" placeholder="Enter your question..." rows="4" required style="resize: none; overflow-y: auto;"></textarea>
                
                <label for="flashcardAnswer">Answer</label>
                <textarea id="flashcardAnswer" placeholder="Enter your answer..." rows="4" required style="resize: none; overflow-y: auto;"></textarea>
            </div>
        </div>

        <div class="flashcard-tab-content hidden" id="aiTab">
            <div class="ai-options">
                <button id="aiTextInput" class="btn btn-primary">Text Input</button>
                <button id="aiFileUpload" class="btn btn-secondary">File Upload</button>
            </div>
        </div>
        
        <div class="modal-footer">
            <div class="flashcard-tab-container">
                <button class="tab-btn active" data-tab="manual">Manual</button>
                <button class="tab-btn" data-tab="ai">AI</button>
            </div>
            <button id="addFlashcardBtn" class="btn btn-success">Add Flashcard</button>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Modal Elements
        const modal = document.getElementById("flashcardModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const createSetBtn = document.getElementById("createSetBtn");
        const flashcardSetName = document.getElementById("flashcardSetName");
        const charCount = document.getElementById("charCount");

        // Rename Modal Elements
        const renameModal = document.getElementById("renameModal");
        const closeRenameModalBtn = document.getElementById("closeRenameModalBtn");
        const renameSetBtn = document.getElementById("renameSetBtn");
        const renameFlashcardSetName = document.getElementById("renameFlashcardSetName");
        const renameCharCount = document.getElementById("renameCharCount");
        let currentRenameSetId = null;

        // Flashcard Create Modal Elements
        const largeFlashcardCreateModal = document.getElementById("largeFlashcardCreateModal");
        const closeLargeFlashcardCreateModalBtn = document.getElementById("closeLargeFlashcardCreateModalBtn");
        const addFlashcardBtn = document.getElementById("addFlashcardBtn");
        const flashcardQuestion = document.getElementById("flashcardQuestion");
        const flashcardAnswer = document.getElementById("flashcardAnswer");
        const manualTab = document.getElementById("manualTab");
        const aiTab = document.getElementById("aiTab");

        // Delete Set Modal Elements
        const deleteSetModal = document.getElementById("deleteSetModal");
        const closeDeleteModalBtn = document.getElementById("closeDeleteModalBtn");
        const cancelDeleteSetBtn = document.getElementById("cancelDeleteSetBtn");
        const confirmDeleteSetBtn = document.getElementById("confirmDeleteSetBtn");
        let currentDeleteSetId = null;

        // Global variable to store currently selected flashcard set ID
        let currentSetId = null;

        // Create Flashcard Set
        function createFlashcardSet() {
            const setName = flashcardSetName.value.trim();
            if (setName.length > 0) {
                fetch("/flashcard-sets", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: setName })
                })
                .then(() => location.reload())
                .catch(error => console.error("Error creating flashcard set:", error));
            }
        }

        // Enable/disable create button + character count
        flashcardSetName.addEventListener("input", function() {
            const length = flashcardSetName.value.length;
            charCount.textContent = `${length} / 30`;
            createSetBtn.disabled = flashcardSetName.value.trim().length === 0;
        });

        // Rename Modal Functions
        window.openRenameModal = function(setId, currentName) {
            renameFlashcardSetName.value = currentName;
            renameCharCount.textContent = `${currentName.length} / 30`;
            renameSetBtn.disabled = true;
            currentRenameSetId = setId;
            renameModal.style.display = "flex";
            renameFlashcardSetName.focus();
        }

        function renameFlashcardSet() {
            const newName = renameFlashcardSetName.value.trim();
            if (newName && newName.length <= 30 && currentRenameSetId) {
                fetch(`/flashcard-sets/${currentRenameSetId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name: newName })
                })
                .then(response => {
                    if (response.ok) {
                        const setElement = document.querySelector(`[data-set-id='${currentRenameSetId}'] .set-name`);
                        if (setElement) setElement.textContent = newName;
                        if (currentSetId === currentRenameSetId) {
                            document.getElementById("setNameHeader").textContent = newName;
                            document.getElementById("setNameHeader").title = newName;
                        }
                        renameModal.style.display = "none";
                    } else {
                        console.error("Error renaming flashcard set.");
                    }
                })
                .catch(error => console.error("Error:", error));
            }
        }

        // Open a Set (show flashcards)
        window.openSet = function(setId, event) {
            if (event && event.target.closest('.menu-btn')) return;

            currentSetId = setId;
            const setElement = document.querySelector(`[data-set-id='${setId}'] .set-name`);
            const setName = setElement ? setElement.textContent : "Unnamed Set";

            const header = document.getElementById("flashcardHeader");
            header.classList.remove("hidden");
            header.classList.add("visible");
            document.getElementById("setNameHeader").textContent = setName;

            fetch(`/flashcard-sets/${setId}/flashcards`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("flashcardCountHeader").textContent = `${data.flashcards.length} flashcards`;
                const flashcardContainer = document.getElementById("flashcardContainer");
                flashcardContainer.innerHTML = "";

                if (data.flashcards.length > 0) {
                    data.flashcards.forEach(flashcard => {
                        const cardDiv = document.createElement("div");
                        cardDiv.className = "flashcard";
                        cardDiv.innerHTML = `<h4>${flashcard.question}</h4><p>${flashcard.answer}</p>`;
                        flashcardContainer.appendChild(cardDiv);
                    });
                } else {
                    flashcardContainer.innerHTML = `<p class="text-center text-muted">No flashcards in this set. Create some!</p>`;
                }
            })
            .catch(error => console.error("Error fetching flashcards:", error));
        };

        // Menu Toggle Function
        window.toggleMenu = function(event, setId) {
            event.stopPropagation();
            document.querySelectorAll(".action-menu.show").forEach(menu => {
                if (menu.id !== `menu-${setId}`) {
                    menu.classList.remove("show");
                }
            });
            const menu = document.getElementById(`menu-${setId}`);
            menu.classList.toggle("show");
        };

        // Delete Set Modal Functions
        window.openDeleteModal = function(setId) {
            currentDeleteSetId = setId;
            deleteSetModal.style.display = "flex";
        }

        // Tab Functionality
        const tabButtons = document.querySelectorAll(".tab-btn");
        tabButtons.forEach(btn => {
            btn.addEventListener("click", function() {
                tabButtons.forEach(b => b.classList.remove("active"));
                this.classList.add("active");
                
                if (this.dataset.tab === "manual") {
                    manualTab.classList.remove("hidden");
                    aiTab.classList.add("hidden");
                } else {
                    aiTab.classList.remove("hidden");
                    manualTab.classList.add("hidden");
                }
            });
        });

        // Event Listeners
        document.getElementById("addFlashcardSet").addEventListener("click", () => {
            modal.style.display = "flex";
        });

        closeModalBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        createSetBtn.addEventListener("click", createFlashcardSet);

        flashcardSetName.addEventListener("keydown", event => {
            if (event.key === "Enter") createFlashcardSet();
        });

        renameFlashcardSetName.addEventListener("input", function() {
            const length = this.value.length;
            renameCharCount.textContent = `${length} / 30`;
            renameSetBtn.disabled = this.value.trim().length === 0;
        });

        renameFlashcardSetName.addEventListener("keydown", event => {
            if (event.key === "Enter") renameFlashcardSet();
        });

        closeRenameModalBtn.addEventListener("click", () => {
            renameModal.style.display = "none";
        });

        renameSetBtn.addEventListener("click", renameFlashcardSet);
        
        document.getElementById("createButton").addEventListener("click", function() {
            if (currentSetId) {
                largeFlashcardCreateModal.style.display = "flex";
                flashcardQuestion.focus();
            } else {
                alert("Please select a flashcard set first.");
            }
        });

        closeLargeFlashcardCreateModalBtn.addEventListener("click", () => {
            largeFlashcardCreateModal.style.display = "none";
        });

        addFlashcardBtn.addEventListener("click", function() {
            const question = flashcardQuestion.value.trim();
            const answer = flashcardAnswer.value.trim();
            
            if (!question || !answer) {
                alert("Please enter both a question and an answer.");
                return;
            }
            
            fetch(`/flashcard-sets/${currentSetId}/flashcards`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ question, answer })
            })
            .then(response => {
                if (response.ok) {
                    openSet(currentSetId);
                    flashcardQuestion.value = "";
                    flashcardAnswer.value = "";
                    closeLargeFlashcardCreateModalBtn.style.display = "none";
                } else {
                    console.error("Error creating flashcard");
                }
            })
            .catch(error => console.error("Error:", error));
        });

        closeDeleteModalBtn.addEventListener("click", () => {
            deleteSetModal.style.display = "none";
        });

        cancelDeleteSetBtn.addEventListener("click", () => {
            deleteSetModal.style.display = "none";
        });

        confirmDeleteSetBtn.addEventListener("click", () => {
            fetch(`/flashcard-sets/${currentDeleteSetId}`, {
                method: "DELETE"
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === "Flashcard set deleted!") {
                    location.reload();
                } else {
                    console.error(data.message);
                }
            })
            .catch(error => console.error("Error deleting flashcard set:", error));
        });

        // Close menus when clicking outside
        document.addEventListener("click", function(event) {
            const openMenus = document.querySelectorAll(".action-menu.show");
            openMenus.forEach(menu => {
                if (!menu.contains(event.target) && !event.target.closest(".menu-btn")) {
                    menu.classList.remove("show");
                }
            });
        });

        // Close modals on Escape
        document.addEventListener("keydown", function(event) {
            if (event.key === "Escape") {
                const modals = document.querySelectorAll(".modal");
                modals.forEach(modal => modal.style.display = "none");
            }
        });
    });
</script>
{% endblock %}