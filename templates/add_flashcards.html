{% extends "layout.html" %}
{% block title %}Add Flashcards{% endblock %}
{% block content %}
<style>
  @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');

  /* Outer container to center content and control max width */
  .outer-container {
    max-width: 1200px;
    margin: 0 auto;
    text-align: center;
  }

  /* Flex container holding both menus side by side */
  .fixed-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 2rem;
    margin: 2rem 0;
  }

  /* Shared styling for both menus */
  .fixed-menu {
    background-color: #f8f9fa;
    width: 450px;
    height: 500px;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Make the right menu scrollable when content exceeds height */
  .scrollable {
    overflow-y: auto;
  }

  /* Flashcard text container to truncate long text */
  .flashcard-text {
    flex: 1;               /* Fills available space */
    max-width: 300px;      /* Adjust as needed to leave room for icons */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    text-align: left;      /* Force left alignment */
  }
  /* Each line (question & answer) also truncated if needed */
  .flashcard-text strong,
  .flashcard-text span {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;      /* Ensure each line is left-aligned */
  }

  /* Icon container for edit/delete so they remain fixed on the right */
  .icon-container {
    display: flex;
    gap: 0.5rem;
  }

  /* Modal styling */
  .modal-overlay {
    display: none; /* Hidden by default */
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 999; /* On top of everything */
  }
  .modal-content {
    background: #fff;
    padding: 2rem;
    border-radius: 8px;
    width: 400px;
    max-width: 90%;
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .close-btn {
    background: none;
    border: none;
    font-size: 1.25rem;
    cursor: pointer;
  }

/* Dark Mode Overrides for Fixed Menu Classes */
  body.dark-mode .fixed-menu {
    background-color: #2c2c2c;
    color: #eee;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
  }

/* Ensure any text inside fixed menus is light in dark mode */
  body.dark-mode .fixed-menu h4,
  body.dark-mode .fixed-menu a,
  body.dark-mode .fixed-menu .btn {
    color: #eee;
  }

/* Override Bootstrap form controls in dark mode */
  body.dark-mode .form-control {
    background-color: #444;  /* Darker background */
    color: #eee;             /* Light text */
    border: 1px solid #555;  /* Subtle border */
  }

/* Override list-group items (flashcards) in dark mode */
  body.dark-mode .fixed-menu .list-group-item {
    background-color: #2c2c2c;  /* Match the fixed-menu background */
    color: #eee;                /* Light text */
    border: 1px solid #444;     /* Adjust border for visibility */
  }

/* Optional: Override modal content if you want it in dark mode */
  body.dark-mode .modal-content {
    background-color: #2c2c2c;
    color: #eee;
  }

  .btn-outline-danger,
  .btn-outline-secondary {
    border: none !important;
    box-shadow: none;
  }

</style>

<div class="outer-container">
  <h2 class="mb-4">Add Flashcards to "{{ deck.title }}"</h2>

  <div class="fixed-container">
    <!-- Left Menu: Add Flashcard Form -->
    <div class="fixed-menu">
      <h4>Add Flashcard</h4>
      <form method="POST">
        <div class="form-group mt-2">
          <label for="question">Question</label>
          <input class="form-control" id="question" name="question" type="text" required>
        </div>
        <div class="form-group mt-2">
          <label for="answer">Answer</label>
          <input class="form-control" id="answer" name="answer" type="text" required>
        </div>
        <button type="submit" class="btn btn-success btn-block mt-3">Add Flashcard</button>
      </form>
    </div>

    <!-- Right Menu: Scrollable List of Flashcards -->
    <div class="fixed-menu scrollable">
      <h4>Current Flashcards</h4>
      {% if flashcards %}
        <ul class="list-group mt-3" id="flashcardList">
          {% for card in flashcards %}
            <li class="list-group-item d-flex align-items-center" id="card-{{ card.id }}">
              <div class="flashcard-text">
                <strong>{{ card.question }}</strong>
                <span>{{ card.answer }}</span>
              </div>
              <div class="icon-container">
                <button class="btn btn-sm btn-outline-secondary" onclick="openEditModal('{{ card.id }}')">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteFlashcard('{{ card.id }}')">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="mt-3">No flashcards yet. Create some!</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Hidden Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h5>Edit Flashcard</h5>
      <button class="close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    <form id="editFlashcardForm">
      <input type="hidden" name="card_id" id="editCardId">
      <div class="form-group mt-3">
        <label for="editQuestion">Question</label>
        <input class="form-control" id="editQuestion" name="question" type="text" required>
      </div>
      <div class="form-group mt-3">
        <label for="editAnswer">Answer</label>
        <input class="form-control" id="editAnswer" name="answer" type="text" required>
      </div>
      <button type="submit" class="btn btn-success btn-block mt-3">Save Changes</button>
    </form>
  </div>
</div>

<script>
  // Open the modal with the existing flashcard data
  function openEditModal(cardId) {
    const modal = document.getElementById('editModal');
    modal.style.display = 'flex'; // Show modal

    // Grab existing question/answer from the DOM
    const cardItem = document.getElementById(`card-${cardId}`);
    const questionText = cardItem.querySelector('.flashcard-text strong').textContent.trim();
    const answerText = cardItem.querySelector('.flashcard-text span').textContent.trim();

    document.getElementById('editCardId').value = cardId;
    document.getElementById('editQuestion').value = questionText;
    document.getElementById('editAnswer').value = answerText;
  }

  // Close the modal
  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  // Handle the form submission via AJAX
  document.getElementById('editFlashcardForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('/update_flashcard', {
      method: 'POST',
      body: new URLSearchParams(formData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the DOM with the new question/answer
        const cardId = formData.get('card_id');
        const newQuestion = formData.get('question');
        const newAnswer = formData.get('answer');
        const cardItem = document.getElementById(`card-${cardId}`);
        cardItem.querySelector('.flashcard-text strong').textContent = newQuestion;
        cardItem.querySelector('.flashcard-text span').textContent = newAnswer;

        closeEditModal();
      } else {
        alert(`Error updating flashcard: ${data.message}`);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
    });
  });

  // Delete flashcard via AJAX
  function deleteFlashcard(cardId) {
    if (confirm("Are you sure you want to delete this flashcard?")) {
      fetch('/delete_flashcard/' + cardId, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const cardItem = document.getElementById('card-' + cardId);
          cardItem.remove();
        } else {
          alert('Error deleting flashcard: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
      });
    }
  }

  // Close modal if user clicks outside of modal-content
  window.onclick = function(event) {
    const editModal = document.getElementById('editModal');
    if (event.target === editModal) {
      closeEditModal();
    }
  };
</script>
{% endblock %}
